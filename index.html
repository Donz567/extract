<!DOCTYPE html>
<html>
<head>
  <title>Sebago File Extractor (GIS)</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</head>
<body>
  <button id="loginBtn">Login & Download Sebago Files</button>

  <script>
    const CLIENT_ID = "YOUR_CLIENT_ID.apps.googleusercontent.com";
    const SCOPES = "https://www.googleapis.com/auth/drive.readonly";
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];

    let tokenClient;

    // Load Drive API
    function gapiLoaded() {
      gapi.load('client', async () => {
        await gapi.client.init({
          discoveryDocs: DISCOVERY_DOCS
        });
      });
    }

    window.onload = () => {
      // Initialize token client
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (response) => {
          if (response.error) throw(response);
          await listAndDownloadFiles();
        },
      });

      document.getElementById("loginBtn").onclick = () => {
        tokenClient.requestAccessToken();
      };

      gapiLoaded();
    };

    async function listAndDownloadFiles() {
      const res = await gapi.client.drive.files.list({
        q: "name contains 'Sebago' and mimeType contains 'spreadsheet'",
        fields: "files(id, name)"
      });

      const files = res.result.files;
      if (!files || files.length === 0) {
        alert("No matching files found.");
        return;
      }

      const zip = new JSZip();

      for (let file of files) {
        const response = await gapi.client.drive.files.get({
          fileId: file.id,
          alt: "media"
        });
        zip.file(file.name, response.body);
      }

      const blob = await zip.generateAsync({ type: "blob" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "Sebago_Files.zip";
      link.click();
    }
  </script>
</body>
</html>
